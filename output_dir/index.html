<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.13.15' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"default_width": "medium", "dataframes": "rich", "code_editor_font_size": 14, "cell_output": "above", "default_table_page_size": 10, "theme": "dark"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000, "default_sql_output": "auto"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "pip"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "medium", "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>poblacion</title>
    <script type="module" crossorigin src="./assets/index-aRpq2G87.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-BqXWXM9d.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.13.15%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%23%3Ccenter%3EConstrucci%C3%B3n%20del%20Grafo%20Poblacional%20de%20Costa%20Rica%20a%20nivel%20Distrital%3C%2Fcenter%3E%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20pandas%20as%20pd%0A%20%20%20%20import%20geopandas%20as%20gpd%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20networkx%20as%20nx%0A%20%20%20%20import%20matplotlib.pyplot%20as%20plt%0A%20%20%20%20import%20plotly.express%20as%20px%0A%20%20%20%20import%20openpyxl%0A%20%20%20%20import%20pyarrow%0A%20%20%20%20import%20plotly.graph_objects%20as%20go%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20return%20go%2C%20gpd%2C%20mo%2C%20np%2C%20nx%2C%20pd%2C%20px%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20organizer)%3A%0A%20%20%20%20organizer.new(level%3D1)%0A%20%20%20%20mo.md(f%22%22%22%23%23%20%7Borganizer.format()%7D.%20**Cargado%2C%20limpieza%20y%20Exploraci%C3%B3n%20de%20los%20Datos**%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20open_data(gpd%2C%20pd)%3A%0A%20%20%20%20district_population_data%20%3D%20pd.read_excel(%0A%20%20%20%20%20%20%20%20%22https%3A%2F%2Fgithub.com%2FAntonio-Tresol%2Fdatascience_lab_two_districts%2Fraw%2Frefs%2Fheads%2Fmain%2Flegacy_notebooks%2Fdata%2Fdf_distritos.xlsx%22%0A%20%20%20%20)%0A%20%20%20%20district_population_data%5B%22Codigo%22%5D%20%3D%20district_population_data%5B%22Codigo%22%5D.astype(%22str%22)%0A%0A%20%20%20%20shapefile_path%20%3D%20%22https%3A%2F%2Fgithub.com%2FAntonio-Tresol%2Fdatascience_lab_two_districts%2Fraw%2Frefs%2Fheads%2Fmain%2Flegacy_notebooks%2Fdata%2FUGED_MGN_2022%2FUGED_MGN_2022.shp%22%0A%0A%20%20%20%20district_geospatial_data%20%3D%20gpd.read_file(shapefile_path)%0A%0A%20%20%20%20district_geospatial_data%20%3D%20district_geospatial_data%5B%0A%20%20%20%20%20%20%20%20district_geospatial_data.geometry.notnull()%0A%20%20%20%20%5D.copy()%0A%0A%20%20%20%20district_geospatial_data%20%3D%20district_geospatial_data.set_crs(epsg%3D5367)%0A%20%20%20%20return%20district_geospatial_data%2C%20district_population_data%0A%0A%0A%40app.cell%0Adef%20join_data(district_geospatial_data%2C%20district_population_data)%3A%0A%20%20%20%20district_data%20%3D%20district_population_data.merge(%0A%20%20%20%20%20%20%20%20district_geospatial_data%2C%20left_on%3D%22Codigo%22%2C%20right_on%3D%22COD_UGED%22%2C%20how%3D%22inner%22%0A%20%20%20%20)%0A%0A%20%20%20%20district_data%20%3D%20district_data.drop(%0A%20%20%20%20%20%20%20%20columns%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22COD_UGED%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22NOMB_UGEC%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22NOMB_UGED%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22ID%22%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20district_data%20%3D%20district_data.rename(%0A%20%20%20%20%20%20%20%20columns%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22NOMB_UGEP%22%3A%20%22provincia%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22Total%22%3A%20%22poblacion_total%22%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20)%0A%20%20%20%20district_data%20%3D%20district_data.rename(%0A%20%20%20%20%20%20%20%20columns%3D%7Bcol%3A%20str(col).lower()%20for%20col%20in%20district_data.columns.to_list()%7D%0A%20%20%20%20)%0A%20%20%20%20return%20(district_data%2C)%0A%0A%0A%40app.cell%0Adef%20_(district_data%2C%20gpd%2C%20mo%2C%20organizer)%3A%0A%20%20%20%20geo_district_data%20%3D%20gpd.GeoDataFrame(district_data)%0A%0A%20%20%20%20organizer.new(level%3D2)%0A%20%20%20%20title_original_data%20%3D%20mo.md(text%3Df%22%23%23%23%20%7Borganizer.format()%7D.%20Datos%20sin%20la%20columna%20de%20geometr%C3%ADa%22)%0A%0A%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20items%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20title_original_data%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20geo_district_data.drop(columns%3D%22geometry%22)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20return%20(geo_district_data%2C)%0A%0A%0A%40app.cell%0Adef%20calculate_metrics(geo_district_data%2C%20mo%2C%20organizer%2C%20polsby_popper)%3A%0A%20%20%20%20%22%22%22Calculate%20district%20metrics%20like%20Polsby-Popper%20compactness%22%22%22%0A%0A%20%20%20%20geo_district_data%5B%22polsby_popper%22%5D%20%3D%20geo_district_data.geometry.apply(polsby_popper)%0A%20%20%20%20geo_district_data%5B%5B%22distrito%22%2C%20%22polsby_popper%22%5D%5D%20%3D%20geo_district_data%5B%0A%20%20%20%20%20%20%20%20%5B%22distrito%22%2C%20%22polsby_popper%22%5D%0A%20%20%20%20%5D.sort_values(by%3D%22polsby_popper%22%2C%20ascending%3DTrue)%0A%0A%20%20%20%20organizer.new(level%3D2)%0A%20%20%20%20title_original_data_with_polsby_popper%20%3D%20mo.md(%0A%20%20%20%20%20%20%20%20text%3Df%22%23%23%23%20%7Borganizer.format()%7D.%20Distritos%20originales%20con%20polsby%20popper%20(sin%20la%20columna%20de%20geometr%C3%ADa)%22%0A%20%20%20%20)%0A%0A%20%20%20%20mo.vstack(%0A%20%20%20%20%20%20%20%20items%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20title_original_data_with_polsby_popper%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20geo_district_data.drop(columns%3D%22geometry%22)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20organizer)%3A%0A%20%20%20%20organizer.new(level%3D2)%0A%20%20%20%20mo.md(f%22%22%22%23%23%23%20%7Borganizer.format()%7D%20Grafo%20de%20contiguidad%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20make_neighbor_graph(build_continuity_graph%2C%20geo_district_data%2C%20nx)%3A%0A%20%20%20%20%22%22%22Create%20the%20contiguity%20graph%20and%20display%20its%20metrics%22%22%22%0A%0A%20%20%20%20G%20%3D%20build_continuity_graph(geo_district_data)%0A%0A%20%20%20%20%23%20Graph%20metrics%0A%20%20%20%20print(f%22N%C3%BAmero%20de%20nodos%3A%20%7BG.number_of_nodes()%7D%22)%0A%20%20%20%20print(f%22N%C3%BAmero%20de%20aristas%3A%20%7BG.number_of_edges()%7D%22)%0A%20%20%20%20grados%20%3D%20%5Bd%20for%20_%2C%20d%20in%20G.degree()%5D%0A%20%20%20%20print(f%22Grado%20medio%3A%20%7Bsum(grados)%20%2F%20len(grados)%3A.2f%7D%22)%0A%20%20%20%20print(f%22N%C3%BAmero%20de%20componentes%20conexas%3A%20%7Bnx.number_connected_components(G)%7D%22)%0A%20%20%20%20return%20(G%2C)%0A%0A%0A%40app.cell%0Adef%20_(G%2C%20nx)%3A%0A%20%20%20%20componentes%20%3D%20list(nx.connected_components(G))%0A%20%20%20%20print(f%22N%C3%BAmero%20de%20componentes%20conexas%3A%20%7Blen(componentes)%7D%22)%0A%20%20%20%20if%20len(componentes)%20%3D%3D%201%3A%0A%20%20%20%20%20%20%20%20print(%22Todos%20los%20distritos%20est%C3%A1n%20contiguamente%20conectados.%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20print(%22Advertencia%3A%20hay%20distritos%20desconectados.%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20plot_map_with_continuity_graph(G%2C%20geo_district_data%2C%20make_graph_map)%3A%0A%20%20%20%20%22%22%22Cell%20for%20executing%20plotting%20functions%22%22%22%0A%0A%20%20%20%20%23%20Display%20the%20contiguity%20graph%0A%20%20%20%20make_graph_map(%0A%20%20%20%20%20%20%20%20G%2C%20geo_district_data%2C%20title%3D%22Grafo%20de%20Contig%C3%BCidad%20de%20Distritos%20sobre%20Mapa%20de%20Poblaci%C3%B3n%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20plot_map(geo_district_data%2C%20make_interactive_map)%3A%0A%20%20%20%20%23%20Display%20the%20interactive%20population%20map%0A%20%20%20%20make_interactive_map(%0A%20%20%20%20%20%20%20%20geo_df%3Dgeo_district_data%2C%0A%20%20%20%20%20%20%20%20title%3D%22Poblaci%C3%B3n%20de%20Distritos%20de%20Costa%20Rica%22%2C%0A%20%20%20%20%20%20%20%20color_col%3D%22poblacion_total%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20organizer)%3A%0A%20%20%20%20organizer.new(level%3D1)%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20f%22%22%22%0A%20%20%20%20%23%23%20%7Borganizer.format()%7D.%20Evaluaci%C3%B3n%20de%20modelos%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20organizer)%3A%0A%20%20%20%20organizer.new(level%3D2)%0A%20%20%20%20mo.md(f%22%22%22%23%23%23%20%7Borganizer.format()%7D.%20Para%20evaluar%0A%20%20%20%20-%20Validar%20que%20el%20grafo%20de%20continuidad%20generado%20por%20el%20clustering%20mantenga%20los%20componenetes%20conexos%20preexistentes.%0A%20%20%20%20-%20Entre%20menos%20desviaci%C3%B3n%20porcentual%20de%20poblaci%C3%B3n%20haya%20entre%20los%20distritos%20nuevos%20(creados%20por%20el%20clustering%2C%20mejor%20esta%20funcionan%20el%20clustering)%0A%20%20%20%20-%20En%20polbsy%20poper%20cercano%20a%20uno%20es%20mejor%0A%20%20%20%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20sklearn.preprocessing%20import%20StandardScaler%0A%20%20%20%20from%20sklearn.preprocessing%20import%20normalize%0A%20%20%20%20from%20sklearn.cluster%20import%20SpectralClustering%0A%20%20%20%20from%20sklearn.cluster%20import%20DBSCAN%0A%20%20%20%20from%20sklearn.cluster%20import%20KMeans%0A%20%20%20%20return%20(KMeans%2C)%0A%0A%0A%40app.cell%0Adef%20_(geo_district_data)%3A%0A%20%20%20%20%23%20Nuevo%20valor%20de%20k%0A%20%20%20%20poblacion_total%20%3D%20geo_district_data%5B%22poblacion_total%22%5D.sum()%0A%20%20%20%20meta_poblacional%20%3D%2045000%20%20%23%20nueva%20cantidad%0A%20%20%20%20cantidad_diputados%20%3D%20poblacion_total%20%2F%20meta_poblacional%0A%0A%20%20%20%20k%20%3D%20round(poblacion_total%20%2F%20meta_poblacional)%0A%20%20%20%20print(f%22N%C3%BAmero%20estimado%20de%20distritos%20(k)%3A%20%7Bk%7D%22)%0A%20%20%20%20return%20(k%2C)%0A%0A%0A%40app.cell%0Adef%20_(KMeans%2C%20geo_district_data%2C%20k%2C%20make_interactive_map%2C%20pd)%3A%0A%20%20%20%20coordinates%20%3D%20pd.DataFrame(%0A%20%20%20%20%20%20%20%20data%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22x%22%3A%20geo_district_data.geometry.centroid.x%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22y%22%3A%20geo_district_data.geometry.centroid.y%2C%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20).values%0A%0A%20%20%20%20kmeans%20%3D%20KMeans(n_clusters%3Dk%2C%20random_state%3D0%2C%20n_init%3D10).fit(coordinates)%0A%20%20%20%20new_geo_districts%20%3D%20geo_district_data.copy()%0A%0A%20%20%20%20new_geo_districts%5B%22distrito_nuevo%22%5D%20%3D%20kmeans.labels_%0A%20%20%20%20%23%20TODO%3A%20hacer%20gr%C3%A1fico%20interactivo%0A%20%20%20%20make_interactive_map(%0A%20%20%20%20%20%20%20%20new_geo_districts%2C%0A%20%20%20%20%20%20%20%20%22Distritos%20Creados%20por%20KMeans%22%2C%0A%20%20%20%20%20%20%20%20%22distrito_nuevo%22%2C%0A%20%20%20%20%20%20%20%20extra_hover_data%3D%7B%22distrito_nuevo%22%3A%20True%7D%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20organizer)%3A%0A%20%20%20%20organizer.new(level%3D1)%0A%20%20%20%20mo.md(f%22%22%22%23%23%20%7Borganizer.format()%7D.%20Anexo%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20evaluation_metrics(np)%3A%0A%20%20%20%20def%20polsby_popper(geometry)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Calculate%20Polsby-Popper%20compactness%20metric%20for%20a%20geometry%22%22%22%0A%20%20%20%20%20%20%20%20if%20geometry%20and%20geometry.area%20%3E%200%20and%20geometry.length%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20(4%20*%20np.pi%20*%20geometry.area)%20%2F%20(geometry.length**2)%0A%20%20%20%20%20%20%20%20return%200%0A%20%20%20%20return%20(polsby_popper%2C)%0A%0A%0A%40app.cell%0Adef%20define_plotting_functions(go%2C%20gpd%2C%20nx%2C%20px)%3A%0A%20%20%20%20%22%22%22Define%20all%20utility%20functions%22%22%22%0A%0A%0A%20%20%20%20def%20build_continuity_graph(geo_df%3A%20gpd.GeoDataFrame)%20-%3E%20nx.Graph%3A%0A%20%20%20%20%20%20%20%20%22%22%22Build%20a%20contiguity%20graph%20from%20geographic%20data%22%22%22%0A%20%20%20%20%20%20%20%20G%20%3D%20nx.Graph()%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20nodes%20with%20population%0A%20%20%20%20%20%20%20%20for%20idx%2C%20row%20in%20geo_df.iterrows()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20G.add_node(idx%2C%20nombre%3Drow%5B%22distrito%22%5D%2C%20poblacion%3Drow%5B%22poblacion_total%22%5D)%0A%0A%20%20%20%20%20%20%20%20%23%20Add%20edges%20between%20contiguous%20districts%0A%20%20%20%20%20%20%20%20for%20i%2C%20geom%20in%20geo_df.geometry.items()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20vecinos%20%3D%20geo_df%5Bgeo_df.geometry.touches(geom)%5D.index%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20v%20in%20vecinos%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20G.has_edge(i%2C%20v)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20G.add_edge(i%2C%20v)%0A%20%20%20%20%20%20%20%20return%20G%0A%0A%0A%20%20%20%20def%20make_graph_map(%0A%20%20%20%20%20%20%20%20G%3A%20nx.Graph%2C%0A%20%20%20%20%20%20%20%20geo_district_data%3A%20gpd.GeoDataFrame%2C%0A%20%20%20%20%20%20%20%20title%3A%20str%2C%0A%20%20%20%20%20%20%20%20color_col%3A%20str%20%3D%20%22poblacion_total%22%2C%0A%20%20%20%20)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%22%22%22Create%20an%20interactive%20map%20showing%20the%20contiguity%20graph%22%22%22%0A%0A%20%20%20%20%20%20%20%20%23%20---%201.%20Create%20the%20Base%20Map%20(with%20hover%20disabled%20on%20polygons)%20---%0A%20%20%20%20%20%20%20%20def%20create_base_map()%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20geo_district_data_viz%20%3D%20geo_district_data.to_crs(epsg%3D4326)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig%20%3D%20px.choropleth_map(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20geo_district_data_viz%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20geojson%3Dgeo_district_data_viz.geometry%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20locations%3Dgeo_district_data_viz.index%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color%3Dcolor_col%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20center%3D%7B%22lat%22%3A%209.93%2C%20%22lon%22%3A%20-84.08%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20zoom%3D7%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20opacity%3D0.5%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3Dtitle%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.update_traces(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hoverinfo%3D%22none%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20selector%3Ddict(type%3D%22choroplethmap%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20fig.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20map_style%3D%22carto-positron%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20margin%3D%7B%22r%22%3A%200%2C%20%22t%22%3A%2040%2C%20%22l%22%3A%200%2C%20%22b%22%3A%200%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend_title_text%3D%22Poblaci%C3%B3n%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20fig%0A%0A%20%20%20%20%20%20%20%20%23%20---%202.%20Generate%20the%20Geographic%20Layout%20for%20the%20Graph%20---%0A%20%20%20%20%20%20%20%20geo_data_for_layout%20%3D%20geo_district_data.to_crs(epsg%3D4326)%0A%20%20%20%20%20%20%20%20pos%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20node%3A%20(geom.centroid.x%2C%20geom.centroid.y)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20node%2C%20geom%20in%20geo_data_for_layout.geometry.items()%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%23%20---%203.%20Create%20the%20Edge%20Layer%20---%0A%20%20%20%20%20%20%20%20edge_x%2C%20edge_y%20%3D%20%5B%5D%2C%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20edge%20in%20G.edges()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20x0%2C%20y0%20%3D%20pos%5Bedge%5B0%5D%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20x1%2C%20y1%20%3D%20pos%5Bedge%5B1%5D%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20edge_x.extend(%5Bx0%2C%20x1%2C%20None%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20edge_y.extend(%5By0%2C%20y1%2C%20None%5D)%0A%0A%20%20%20%20%20%20%20%20edge_trace%20%3D%20go.Scattermap(%0A%20%20%20%20%20%20%20%20%20%20%20%20lon%3Dedge_x%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20lat%3Dedge_y%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22lines%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20line%3Ddict(width%3D1%2C%20color%3D%22%23FFFFFF%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20hoverinfo%3D%22none%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%204.%20Create%20the%20Node%20Layer%20with%20Rich%20Tooltip%20Information%20---%0A%20%20%20%20%20%20%20%20node_lon%2C%20node_lat%2C%20hover_texts%2C%20custom_data%20%3D%20%5B%5D%2C%20%5B%5D%2C%20%5B%5D%2C%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20node%20in%20G.nodes()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20lon%2C%20lat%20%3D%20pos%5Bnode%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20node_lon.append(lon)%0A%20%20%20%20%20%20%20%20%20%20%20%20node_lat.append(lat)%0A%20%20%20%20%20%20%20%20%20%20%20%20info%20%3D%20geo_data_for_layout.loc%5Bnode%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20hover_texts.append(info%5B%22distrito%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20custom_data.append(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20info%5B%22provincia%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20info%5B%22poblacion_total%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20info%5B%22area_km2%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20node_trace%20%3D%20go.Scattermap(%0A%20%20%20%20%20%20%20%20%20%20%20%20lon%3Dnode_lon%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20lat%3Dnode_lat%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20text%3Dhover_texts%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20customdata%3Dcustom_data%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20mode%3D%22markers%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20marker%3Ddict(size%3D9%2C%20color%3D%22black%22%2C%20opacity%3D0.9)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20showlegend%3DFalse%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20hovertemplate%3D(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%3Cb%3E%25%7Btext%7D%3C%2Fb%3E%3Cbr%3E%3Cbr%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%3Cb%3EProvincia%3A%3C%2Fb%3E%20%25%7Bcustomdata%5B0%5D%7D%3Cbr%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%3Cb%3EPoblaci%C3%B3n%3A%3C%2Fb%3E%20%25%7Bcustomdata%5B1%5D%3A%2C%7D%3Cbr%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%3Cb%3E%C3%81rea%3A%3C%2Fb%3E%20%25%7Bcustomdata%5B2%5D%3A.2f%7D%20km%C2%B2%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%3Cextra%3E%3C%2Fextra%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20---%205.%20Combine%20the%20Map%20and%20the%20Graph%20Layers%20---%0A%20%20%20%20%20%20%20%20fig%20%3D%20create_base_map()%0A%20%20%20%20%20%20%20%20fig.add_trace(edge_trace)%0A%20%20%20%20%20%20%20%20fig.add_trace(node_trace)%0A%0A%20%20%20%20%20%20%20%20%23%20---%206.%20Show%20the%20Final%20Interactive%20Visualization%20---%0A%20%20%20%20%20%20%20%20fig.show()%0A%0A%0A%20%20%20%20def%20make_interactive_map(%0A%20%20%20%20%20%20%20%20geo_df%3A%20gpd.GeoDataFrame%2C%0A%20%20%20%20%20%20%20%20title%3A%20str%2C%0A%20%20%20%20%20%20%20%20color_col%3A%20str%2C%0A%20%20%20%20%20%20%20%20extra_hover_data%3A%20dict%20%3D%20%7B%7D%2C%0A%20%20%20%20)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%22%22%22Create%20an%20interactive%20choropleth%20map%22%22%22%0A%20%20%20%20%20%20%20%20geo_district_data_viz%20%3D%20geo_df.to_crs(epsg%3D4326)%0A%20%20%20%20%20%20%20%20hover_data%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22provincia%22%3A%20True%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22poblacion_total%22%3A%20%22%3A%2C%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22area_km2%22%3A%20%22%3A.2f%22%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20hover_data.update(extra_hover_data)%0A%20%20%20%20%20%20%20%20fig%20%3D%20px.choropleth_map(%0A%20%20%20%20%20%20%20%20%20%20%20%20geo_district_data_viz%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20geojson%3Dgeo_district_data_viz.geometry%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20locations%3Dgeo_district_data_viz.index%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20color%3Dcolor_col%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20hover_name%3D%22distrito%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20hover_data%3Dhover_data%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20center%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22lat%22%3A%209.93%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22lon%22%3A%20-84.08%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20zoom%3D7%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20opacity%3D0.7%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20title%3Dtitle%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Customize%20the%20layout%20for%20a%20cleaner%20look%0A%20%20%20%20%20%20%20%20fig.update_layout(%0A%20%20%20%20%20%20%20%20%20%20%20%20margin%3D%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22r%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22t%22%3A%2040%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22l%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22b%22%3A%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20legend_title_text%3D%22Poblaci%C3%B3n%22%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20To%20show%20the%20figure%20in%20a%20notebook%20or%20script%0A%20%20%20%20%20%20%20%20fig.show()%0A%20%20%20%20return%20build_continuity_graph%2C%20make_graph_map%2C%20make_interactive_map%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20utils()%3A%0A%20%20%20%20class%20HierarchyOrganizer%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20A%20class%20to%20manage%20and%20track%20numbering%20for%20a%20hierarchy%20of%20any%20depth.%0A%0A%20%20%20%20%20%20%20%20This%20organizer%20can%20handle%20numbering%20schemes%20like%20%221%22%2C%20%221.1%22%2C%20%221.1.1%22%2C%20etc.%2C%0A%20%20%20%20%20%20%20%20making%20it%20useful%20for%20complex%20documents%2C%20outlines%2C%20or%20task%20lists.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20depth%3A%20int%20%3D%203)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Initializes%20the%20organizer%20for%20a%20given%20hierarchy%20depth.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Args%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20depth%20(int%2C%20optional)%3A%20The%20number%20of%20levels%20in%20the%20hierarchy.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Defaults%20to%203.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20isinstance(depth%2C%20int)%20or%20depth%20%3C%201%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22Depth%20must%20be%20a%20positive%20integer.%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self._depth%20%3D%20depth%0A%20%20%20%20%20%20%20%20%20%20%20%20self._state%20%3D%20%5B0%5D%20*%20self._depth%0A%0A%20%20%20%20%20%20%20%20def%20new(self%2C%20level%3A%20int)%20-%3E%20list%5Bint%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Starts%20a%20new%20item%20at%20the%20specified%20level%2C%20resetting%20all%20lower%20levels.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20For%20example%2C%20calling%20new(1)%20for%20Section%20will%20create%20a%20new%20Section%201%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20and%20calling%20new(2)%20for%20Subsection%20will%20create%20a%20new%20Subsection%201.1.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Args%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20level%20(int)%3A%20The%201-based%20level%20to%20increment%20(e.g.%2C%201%20for%20section%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%202%20for%20subsection).%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20list%5Bint%5D%3A%20The%20new%20state%20of%20the%20hierarchy%20as%20a%20list%20of%20numbers.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20not%20(1%20%3C%3D%20level%20%3C%3D%20self._depth)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20IndexError(f%22Level%20must%20be%20between%201%20and%20%7Bself._depth%7D.%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20level_index%20%3D%20level%20-%201%20%20%23%20Convert%20to%200-based%20index%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Increment%20the%20specified%20level%0A%20%20%20%20%20%20%20%20%20%20%20%20self._state%5Blevel_index%5D%20%2B%3D%201%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Reset%20all%20subsequent%20(lower)%20levels%20to%20zero%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%20in%20range(level_index%20%2B%201%2C%20self._depth)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self._state%5Bi%5D%20%3D%200%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.state%0A%0A%20%20%20%20%20%20%20%20%40property%0A%20%20%20%20%20%20%20%20def%20state(self)%20-%3E%20list%5Bint%5D%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Returns%20the%20current%20hierarchy%20state%20as%20a%20list%20of%20numbers.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20list(self._state)%0A%0A%20%20%20%20%20%20%20%20def%20format(self)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20Formats%20the%20current%20state%20into%20a%20dot-separated%20string%20like%20%221.2.1%22.%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20Trailing%20zeros%20are%20omitted%20for%20a%20clean%2C%20standard%20representation.%0A%20%20%20%20%20%20%20%20%20%20%20%20For%20example%2C%20a%20state%20of%20%5B2%2C%201%2C%200%5D%20is%20formatted%20as%20%222.1%22.%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Find%20the%20last%20level%20that%20is%20not%20zero%0A%20%20%20%20%20%20%20%20%20%20%20%20last_significant_index%20%3D%20-1%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20i%20in%20range(self._depth%20-%201%2C%20-1%2C%20-1)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20self._state%5Bi%5D%20!%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20last_significant_index%20%3D%20i%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20If%20all%20levels%20are%20zero%20(initial%20state)%2C%20return%20%220%22%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20last_significant_index%20%3D%3D%20-1%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20%220%22%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Join%20the%20numbers%20up%20to%20the%20last%20significant%20level%0A%20%20%20%20%20%20%20%20%20%20%20%20active_levels%20%3D%20self._state%5B%3A%20last_significant_index%20%2B%201%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%22.%22.join(map(str%2C%20active_levels))%0A%0A%20%20%20%20%20%20%20%20def%20reset(self)%20-%3E%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%22%22Resets%20the%20organizer%20back%20to%20its%20initial%20state.%22%22%22%0A%20%20%20%20%20%20%20%20%20%20%20%20self._state%20%3D%20%5B0%5D%20*%20self._depth%0A%0A%0A%20%20%20%20organizer%20%3D%20HierarchyOrganizer()%0A%20%20%20%20return%20(organizer%2C)%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
